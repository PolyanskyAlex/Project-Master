Детализированная Архитектура

### 2.1. Высокоуровневая Архитектура

Система состоит из трех основных компонентов, взаимодействующих через стандартизированные протоколы: Веб-интерфейс, Go-Бэкенд и Расширение для IDE. База данных PostgreSQL является центральным хранилищем данных.

```
+-----------------+       HTTP/JSON       +-----------------+       SQL       +-----------------+
|                 | <-------------------> |                 | <-------------> |                 |
|   Веб-интерфейс |                       |   Go-Бэкенд     |                 |   PostgreSQL    |
|   (Frontend)    |                       |   (API Server)  |                 |   (Database)    |
|                 |                       |                 |                 |                 |
+-----------------+                       +-----------------+                 +-----------------+
         ^                                        ^
         |                                        |
         |           HTTP/JSON (API Calls)        |
         |                                        |
         |                                        |
+-------------------------+                       |
|                         |                       |
|   Расширение для IDE    | <---------------------+
|   (Cursor/VS Code)      |
|                         |
+-------------------------+
```

### 2.2. Логическая Архитектура

Go-Бэкенд будет построен по принципам слоистой архитектуры, обеспечивающей разделение ответственности и модульность.

```
+-------------------------------------------------------------------------------------------------+
|                                          Go-Бэкенд                                              |
+-------------------------------------------------------------------------------------------------+
|                                                                                                 |
|  +-----------------+   +-----------------+   +-----------------+   +-----------------+        |
|  |                 |   |                 |   |                 |   |                 |        |
|  |    Handlers     |   |     Services    |   |   Repositories  |   |     Models      |        |
|  | (HTTP API Layer)|<->|(Business Logic) |<->|(Data Access Layer)|<->|(Data Structures)|        |
|  |                 |   |                 |   |                 |   |                 |        |
|  +-----------------+   +-----------------+   +-----------------+   +-----------------+        |
|          ^                                                                                      |
|          |                                                                                      |
|          | (Routing)                                                                            |
|          |                                                                                      |
|  +-----------------+                                                                            |
|  |                 |                                                                            |
|  |     Router      |                                                                            |
|  | (HTTP Routing)  |                                                                            |
|  |                 |                                                                            |
|  +-----------------+                                                                            |
|                                                                                                 |
+-------------------------------------------------------------------------------------------------+
          |
          | (DB Connection)
          V
+-----------------+
|   PostgreSQL    |
+-----------------+
```

*   **Router:** Отвечает за маршрутизацию входящих HTTP-запросов к соответствующим обработчикам (Handlers).
*   **Handlers:** Обрабатывают HTTP-запросы, парсят входные данные, вызывают методы из слоя Services и формируют HTTP-ответы. Отвечают за взаимодействие с внешним миром.
*   **Services:** Содержат основную бизнес-логику приложения. Координируют работу репозиториев, выполняют валидацию, применяют бизнес-правила.
*   **Repositories:** Отвечают за взаимодействие с базой данных. Предоставляют абстракцию для CRUD-операций над сущностями, скрывая детали работы с БД.
*   **Models:** Определяют структуры данных (Go structs), представляющие сущности предметной области (Project, Task, Document, Comment, FunctionalBlock, OperationLog). Используются всеми слоями.

**Структура каталогов Go-Бэкенда:**

```
project-manager/
├── main.go                     # Точка входа, инициализация сервера, роутера, БД
├── go.mod                      # Модуль Go
├── go.sum
├── Dockerfile                  # Для сборки Go-приложения
├── docker-compose.yml          # Для запуска PostgreSQL
├── .env                        # Переменные окружения (DB_URL, PORT, API_KEY)
├── config/                     # Настройки приложения
│   └── config.go               # Загрузка конфигурации из .env
├── database/                   # Подключение к БД, миграции
│   ├── db.go                   # Функции подключения и инициализации БД
│   └── migrations/             # SQL-файлы для миграций
│       ├── 001_create_tables.up.sql
│       └── 001_create_tables.down.sql
├── models/                     # Структуры данных (Go structs)
│   ├── project.go
│   ├── task.go
│   ├── document.go
│   ├── comment.go
│   ├── functional_block.go
│   └── operation_log.go
├── repositories/               # Взаимодействие с БД (CRUD)
│   ├── project_repo.go
│   ├── task_repo.go
│   ├── document_repo.go
│   ├── comment_repo.go
│   └── functional_block_repo.go
├── services/                   # Бизнес-логика
│   ├── project_service.go      # Логика для проектов
│   ├── task_service.go         # Логика для задач (включая нумерацию, валидацию статусов)
│   ├── document_service.go     # Логика для документов
│   ├── functional_block_service.go # Логика для функциональных блоков
│   └── auth_service.go         # Простая аутентификация
├── handlers/                   # Обработчики HTTP-запросов
│   ├── project_handler.go
│   ├── task_handler.go
│   ├── document_handler.go
│   ├── functional_block_handler.go
│   └── auth_handler.go
├── router/                     # Настройка маршрутизатора
│   └── router.go               # Определение всех HTTP-маршрутов
└── utils/                      # Вспомогательные утилиты
    └── uuid.go                 # Генерация UUID
    └── validation.go           # Функции валидации
```

**Структура каталогов Веб-интерфейса (Frontend - React/Vue/Angular):**

```
frontend/
├── public/
├── src/
│   ├── App.js/tsx              # Главный компонент приложения
│   ├── index.js/tsx            # Точка входа
│   ├── components/             # Переиспользуемые UI-компоненты (кнопки, формы, таблицы)
│   │   ├── Header.js/tsx       # Панель навигации
│   │   ├── ProjectCard.js/tsx
│   │   ├── TaskItem.js/tsx
│   │   └── DocumentEditor.js/tsx # Редактор документов с подсветкой JSON
│   ├── pages/                  # Страницы приложения
│   │   ├── ProjectsPage.js/tsx
│   │   ├── ProjectDetailsPage.js/tsx
│   │   ├── TaskDetailsPage.js/tsx
│   │   ├── DocumentDetailsPage.js/tsx
│   │   ├── FunctionalBlocksPage.js/tsx
│   │   └── SettingsPage.js/tsx
│   ├── services/               # Взаимодействие с Go-бэкендом (API-клиент)
│   │   ├── api.js/ts
│   │   ├── projectService.js/ts
│   │   ├── taskService.js/ts
│   │   └── ...
│   ├── hooks/                  # Пользовательские хуки (для React)
│   ├── store/                  # Управление состоянием (Redux/Zustand/Vuex)
│   ├── styles/                 # Глобальные стили, утилиты CSS
│   └── utils/                  # Вспомогательные функции (форматирование, валидация UI)
├── package.json
├── tsconfig.json (если TypeScript)
```

**Структура каталогов Расширения для IDE (VS Code Extension):**

```
vscode-extension/
├── package.json                # Манифест расширения
├── tsconfig.json
├── src/
│   ├── extension.ts            # Точка входа расширения, регистрация команд, Tree View
│   ├── api/                    # Клиент для Go-бэкенда
│   │   └── pmApiClient.ts
│   ├── views/                  # Логика для Tree View провайдеров
│   │   ├── projectsProvider.ts
│   │   └── tasksProvider.ts
│   ├── commands/               # Реализация команд (createTask, openDocument, executeMcp)
│   │   ├── projectCommands.ts
│   │   ├── taskCommands.ts
│   │   ├── documentCommands.ts
│   │   └── mcpCommands.ts
│   ├── models/                 # TypeScript интерфейсы для данных PM-системы
│   │   ├── project.ts
│   │   ├── task.ts
│   │   └── document.ts
│   ├── utils/                  # Вспомогательные утилиты (парсинг .mcp, уведомления)
│   │   └── mcpParser.ts
│   └── config.ts               # Управление настройками расширения
├── .vscodeignore
├── README.md
```

### 2.3. Физическая/Развертываемая Архитектура

На первом этапе система будет развернута локально с использованием Docker Compose для упрощения управления зависимостями.

```
+-------------------------------------------------------------------------------------------------+
|                                          Хост-система                                           |
|                                                                                                 |
|  +-------------------------------------------------------------------------------------------+  |
|  |                                      Docker Engine                                        |  |
|  |                                                                                           |  |
|  |  +-----------------+      +-----------------+      +-----------------+      +---------+  |  |
|  |  |                 |      |                 |      |                 |      |         |  |  |
|  |  |   Container:    |      |   Container:    |      |   Container:    |      |  Volume |  |  |
|  |  |   PostgreSQL    |      |   Go-Бэкенд     |      |   Веб-интерфейс |      |  db_data|  |  |
|  |  |   (db)          |      |   (go_app)      |      |   (frontend)    |      |         |  |  |
|  |  |   Port: 5432    |      |   Port: 8080    |      |   Port: 3000    |      |         |  |  |
|  |  +-----------------+      +-----------------+      +-----------------+      +---------+  |  |
|  |          ^                        ^                        ^                                |
|  |          |                        |                        |                                |
|  |          +------------------------+------------------------+ (Internal Docker Network)      |
|  |                                                                                           |  |
|  +-------------------------------------------------------------------------------------------+  |
|                                                                                                 |
|  +-------------------------+                                                                    |
|  |                         |                                                                    |
|  |   Cursor IDE / VS Code  | <-----------------------------------------------------------------+
|  |   (с установленным      |                                 HTTP/JSON (localhost:8080)        |
|  |   Расширением)          |                                                                    |
|  +-------------------------+                                                                    |
|                                                                                                 |
+-------------------------------------------------------------------------------------------------+
```

*   **PostgreSQL Container (`db`):** Изолированный контейнер для базы данных. Данные будут персистентно храниться в Docker Volume (`db_data`).
*   **Go Backend Container (`go_app`):** Контейнер для Go-приложения. Будет слушать на порту 8080. Взаимодействует с `db` по внутренней сети Docker.
*   **Frontend Container (`frontend`):** Контейнер для веб-интерфейса. Будет слушать на порту 3000 (или другом, используемом фреймворком). Взаимодействует с `go_app` по внутренней сети Docker.
*   **Cursor IDE / VS Code:** Запускается на хост-системе. Расширение внутри IDE будет обращаться к Go-бэкенду по `localhost:8080`.

### 2.4. Технологический Стек

*   **Бэкенд:**
    *   **Язык:** Go (Golang)
    *   **Веб-фреймворк:** `github.com/go-chi/chi/v5` (легковесный, модульный роутер)
    *   **ORM/DB Driver:** `github.com/jackc/pgx/v5` (высокопроизводительный драйвер для PostgreSQL)
    *   **Миграции БД:** `github.com/golang-migrate/migrate/v4`
    *   **Конфигурация:** `github.com/joho/godotenv` (для загрузки .env)
    *   **UUID:** `github.com/google/uuid`
    *   **Обоснование:** Go выбран за его производительность, низкое потребление ресурсов, сильную типизацию и отличную поддержку конкурентности, что делает его идеальным для бэкенд-сервисов. `Chi` и `pgx` — легковесные и производительные библиотеки, соответствующие философии Go.
*   **База Данных:**
    *   **СУБД:** PostgreSQL
    *   **Обоснование:** PostgreSQL — мощная, надежная, объектно-реляционная СУБД с открытым исходным кодом, хорошо подходящая для структурированных данных и обеспечивающая целостность данных.
*   **Веб-интерфейс (Frontend):**
    *   **Фреймворк:** React (с Create React App или Vite)
    *   **UI-библиотека/Стили:** Tailwind CSS (для быстрого и гибкого стилизования) или Chakra UI/Material UI (для готовых компонентов).
    *   **Обоснование:** React — один из самых популярных и зрелых JavaScript-фреймворков для создания интерактивных пользовательских интерфейсов, с большим сообществом и экосистемой. Tailwind CSS обеспечивает высокую гибкость в дизайне.
*   **Расширение для IDE:**
    *   **Язык:** TypeScript
    *   **API:** VS Code Extension API
    *   **HTTP-клиент:** `axios` или встроенный `fetch`
    *   **Обоснование:** TypeScript обеспечивает строгую типизацию и улучшает поддерживаемость кода. VS Code Extension API — это стандартный способ взаимодействия с IDE.

### 2.5. Модели Данных

Предварительные схемы таблиц в PostgreSQL. Все таблицы будут иметь `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`, `created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP`, `updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP`.

**`functional_blocks`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор блока  |
| name              | VARCHAR(255)        | Название функционального блока  |
| prefix            | VARCHAR(6) UNIQUE   | Уникальный префикс (до 6 лат. букв) |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
| updated_at        | TIMESTAMP WITH TIME ZONE | Время последнего обновления  |
+-------------------+---------------------+---------------------------------+
```

**`projects`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор проекта|
| name              | VARCHAR(255) NOT NULL | Название проекта              |
| description       | TEXT                | Описание проекта              |
| status            | VARCHAR(50)         | Статус проекта (New, In Progress, Done) |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
| updated_at        | TIMESTAMP WITH TIME ZONE | Время последнего обновления  |
+-------------------+---------------------+---------------------------------+
```

**`tasks`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор задачи |
| project_id        | UUID REFERENCES projects(id) | ID проекта, к которому привязана задача |
| functional_block_id | UUID REFERENCES functional_blocks(id) | ID функционального блока (NULLABLE) |
| number            | VARCHAR(255) UNIQUE | Уникальный номер задачи (AUTH-123) |
| title             | VARCHAR(255) NOT NULL | Название задачи               |
| description       | TEXT                | Описание задачи               |
| status            | VARCHAR(50)         | Статус задачи (To Do, In Progress, Done, etc.) |
| priority          | VARCHAR(50)         | Приоритет задачи (High, Medium, Low) |
| type              | VARCHAR(50)         | Тип задачи (New Feature, Bug, Refactoring, etc.) |
| role              | VARCHAR(255)        | Предполагаемая роль исполнителя |
| result            | TEXT                | Результат выполнения задачи (для конечных статусов) |
| parent_task_id    | UUID REFERENCES tasks(id) | ID родительской задачи (для дефектов) |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
| updated_at        | TIMESTAMP WITH TIME ZONE | Время последнего обновления  |
+-------------------+---------------------+---------------------------------+
```

**`comments`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор комментария |
| task_id           | UUID REFERENCES tasks(id) | ID задачи, к которой привязана комментарий |
| user_identifier   | VARCHAR(255)        | Идентификатор пользователя/агента (e.g., "Пользователь", "AI Агент") |
| content           | TEXT                | Текст комментария             |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
+-------------------+---------------------+---------------------------------+
```

**`documents`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор документа |
| project_id        | UUID REFERENCES projects(id) | ID проекта, к которому привязан документ |
| type              | VARCHAR(50)         | Тип документа (BRD, SAD, AI-Ready, AI Executable) |
| title             | VARCHAR(255)        | Заголовок документа           |
| content           | TEXT                | Содержание документа (Markdown/JSON) |
| agent_editable    | BOOLEAN             | Флаг: разрешено ли AI-агенту редактировать |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
| updated_at        | TIMESTAMP WITH TIME ZONE | Время последнего обновления  |
+-------------------+---------------------+---------------------------------+
```

**`operation_logs`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор лога   |
| task_id           | UUID REFERENCES tasks(id) | ID задачи, к которой относится лог |
| user_identifier   | VARCHAR(255)        | Идентификатор пользователя/агента |
| operation_type    | VARCHAR(50)         | Тип операции (e.g., "status_change", "priority_update") |
| details           | JSONB               | Детали операции (e.g., {"old_status": "ToDo", "new_status": "In Progress"}) |
| created_at        | TIMESTAMP WITH TIME ZONE | Время операции               |
+-------------------+---------------------+---------------------------------+
```

**`project_plan_sequences`**
```
+-------------------+---------------------+---------------------------------+
|      Column       |        Type         |           Description           |
+-------------------+---------------------+---------------------------------+
| id                | UUID                | Уникальный идентификатор записи |
| project_id        | UUID REFERENCES projects(id) | ID проекта, к которому относится план |
| task_id           | UUID REFERENCES tasks(id) | ID задачи в последовательности |
| sequence_order    | INTEGER             | Порядок задачи в плане (1, 2, 3...) |
| created_at        | TIMESTAMP WITH TIME ZONE | Время создания               |
| updated_at        | TIMESTAMP WITH TIME ZONE | Время последнего обновления  |
+-------------------+---------------------+---------------------------------+
```

### 2.6. Принципы Проектирования, Безопасность, Масштабируемость, Отказоустойчивость

*   **Принципы Проектирования:**
    *   **SOLID:** Применяется в Go-бэкенде для обеспечения модульности, тестируемости и расширяемости (например, разделение репозиториев и сервисов).
    *   **DRY (Don't Repeat Yourself):** Избегание дублирования кода, особенно в логике валидации и взаимодействии с БД.
    *   **Clean Architecture / Layered Architecture:** Четкое разделение слоев (Handlers, Services, Repositories, Models) для изоляции бизнес-логики от деталей инфраструктуры.
    *   **Domain-Driven Design (DDD) Lite:** Сущности (Project, Task, Document) и их поведение определяются в слое Models и Services.
*   **Безопасность:**
    *   **Аутентификация:** На первом этапе — простой API-ключ/предопределенный логин-пароль. В будущем — JWT или OAuth2.
    *   **Валидация Входных Данных:** Строгая валидация всех входящих запросов на бэкенде для предотвращения инъекций и некорректных данных.
    *   **Защита от SQL-инъекций:** Использование параметризованных запросов через `pgx`.
    *   **HTTPS:** В продакшене обязательно, на локальном этапе — опционально.
    *   **Разделение ролей:** На данном этапе минимальное, но архитектура БД позволяет в будущем добавить полноценную ролевую модель.
*   **Масштабируемость:**
    *   **Stateless Backend:** Go-бэкенд будет stateless, что позволит легко горизонтально масштабировать его путем добавления новых инстансов.
    *   **PostgreSQL:** Выбран как масштабируемая реляционная СУБД.
    *   **Docker/Containerization:** Обеспечивает легкое развертывание и масштабирование компонентов.
*   **Отказоустойчивость:**
    *   **Контейнеризация:** Позволяет легко перезапускать упавшие сервисы.
    *   **Логирование:** Подробное логирование для быстрого выявления и устранения проблем.
    *   **Обработка Ошибок:** Грамотная обработка ошибок на всех уровнях (API, БД, бизнес-логика) с возвратом информативных сообщений.

### 2.7. API и Протоколы Взаимодействия

Все взаимодействия между компонентами (Frontend <-> Go Backend, Extension <-> Go Backend) осуществляются по протоколу **HTTP/1.1** с использованием формата данных **JSON**.

**Пример API-эндпоинтов (Go Backend):**

```
+-------------------------------------------------------------------------------------------------+
|                                          Go-Бэкенд API                                          |
+-------------------------------------------------------------------------------------------------+
|                                                                                                 |
|  /api/v1/auth/login (POST)                                                                      |
|  /api/v1/functional-blocks (GET, POST)                                                          |
|  /api/v1/functional-blocks/{id} (GET, PUT, DELETE)                                              |
|  /api/v1/projects (GET, POST)                                                                   |
|  /api/v1/projects/{id} (GET, PUT, DELETE)                                                       |
|  /api/v1/projects/{id}/tasks (GET, POST)                                                        |
|  /api/v1/tasks/{id} (GET, PUT, DELETE)                                                          |
|  /api/v1/tasks/{id}/comments (GET, POST)                                                        |
|  /api/v1/comments/{id} (DELETE)                                                                 |
|  /api/v1/projects/{id}/documents (GET, POST)                                                    |
|  /api/v1/documents/{id} (GET, PUT, DELETE)                                                      |
|  /api/v1/projects/{id}/plan (GET, PUT)                                                          |
|  /api/v1/tasks/{id}/logs (GET)                                                                  |
|                                                                                                 |
+-------------------------------------------------------------------------------------------------+
```

**Пример JSON-контракта для создания задачи (`POST /api/v1/projects/{id}/tasks`):**

```json
{
  "title": "Реализовать авторизацию пользователя",
  "description": "Разработать функционал регистрации, входа и выхода из системы.",
  "status": "Новая",
  "priority": "Высокий",
  "type": "Новый функционал",
  "role": "Backend Dev",
  "functionalBlockId": "uuid-функционального-блока-авторизации"
}
```

**Пример JSON-контракта для обновления статуса задачи (`PUT /api/v1/tasks/{id}`):**

```json
{
  "status": "Done",
  "result": "Функционал авторизации полностью реализован и протестирован."
}
```