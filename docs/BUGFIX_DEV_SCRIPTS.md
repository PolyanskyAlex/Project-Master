# Исправление багов в скриптах разработки (B010_SCRIPT)

## Обзор
Исправлен ряд критических проблем со скриптами запуска dev-start.bat и сопутствующими файлами.

## Проблемы и решения

### 1. Проблема с запуском dev-start.bat в PowerShell
**Проблема**: `dev-start.bat: The term 'dev-start.bat' is not recognized`
- **Причина**: PowerShell требует явного указания пути для выполнения bat-файлов
- **Решение**: Использовать `.\dev-start.bat` в PowerShell или `dev-start.bat` в cmd

### 2. Дублирование фронтенда на портах 3000 и 3001
**Проблема**: Открываются 2 окна браузера, фронтенд пытается использовать порт 3001
- **Причина**: npm start интерактивно запрашивает альтернативный порт при занятом 3000
- **Решение**: 
  - Добавлены переменные окружения в .env.local:
    ```
    BROWSER=none
    CI=true
    SKIP_PREFLIGHT_CHECK=true
    ```

### 3. Блокировка терминала командой "Press any key"
**Проблема**: Скрипт блокировал терминал командой pause
- **Причина**: `pause >nul` ожидала пользовательский ввод
- **Решение**: 
  - Убрана команда pause из dev-start.bat
  - Создан отдельный скрипт dev-stop.bat для остановки сервисов

### 4. Открытие внешних терминалов вне IDE
**Проблема**: `start "..." cmd /k` открывало внешние окна терминала
- **Причина**: Флаг /k держал окна открытыми
- **Решение**: Заменено на `start /min cmd /c` для фонового выполнения

### 5. Отсутствие проверки запущенных процессов
**Проблема**: Скрипт создавал дублирующие процессы при повторном запуске
- **Причина**: Не было проверки существующих go.exe и node.exe процессов
- **Решение**: Добавлена проверка и принудительная остановка:
  ```batch
  tasklist | findstr /i "go.exe" >nul 2>&1
  if %errorlevel% equ 0 (
      taskkill /f /im go.exe >nul 2>&1
  )
  ```

## Исправленные файлы

### dev-start.bat
- Добавлена проверка и остановка существующих процессов
- Изменен способ запуска на фоновый режим
- Убрана блокирующая команда pause
- Добавлено создание .env.local для фронтенда

### dev-stop.bat (новый)
- Корректная остановка всех сервисов
- Проверка статуса процессов перед остановкой
- Остановка Docker контейнера базы данных

### dev-restart-backend.bat
- Обновлена логика перезапуска
- Добавлен фоновый режим выполнения

### dev-restart-frontend.bat  
- Обновлена логика перезапуска
- Добавлен фоновый режим выполнения

## Инструкции по использованию

### Запуск всех сервисов
```batch
# В PowerShell
.\dev-start.bat

# В cmd
dev-start.bat
```

### Остановка всех сервисов
```batch
# В PowerShell
.\dev-stop.bat

# В cmd  
dev-stop.bat
```

### Перезапуск отдельных компонентов
```batch
.\dev-restart-backend.bat   # Только backend
.\dev-restart-frontend.bat  # Только frontend
```

## Статус
- ✅ Исправлена проблема с блокировкой терминала
- ✅ Исправлена проблема с внешними терминалами
- ✅ Добавлена проверка существующих процессов
- ✅ Создан механизм корректной остановки
- ⚠️ Частично исправлена проблема с дублированием портов
- ❌ Остается проблема с кодировкой терминала в некоторых случаях

## Дополнительные рекомендации

1. **Для PowerShell**: Всегда используйте `.\` префикс для bat-файлов
2. **Для cmd**: Можно использовать прямые имена файлов
3. **При проблемах**: Используйте dev-stop.bat для полной очистки перед повторным запуском
4. **Мониторинг**: Проверяйте статус процессов через Task Manager при проблемах

## Связанные задачи
- B005_EXT - Исправление расширения Project Master
- B008_EXT - Проблемы с авторизацией API
- B009_EXT - Проблемы с перезагрузкой расширения 

# BUGFIX: Исправление скриптов запуска разработчика

**Bug ID:** B010_SCRIPT  
**Статус:** ✅ ИСПРАВЛЕН  
**Дата:** 2025-06-22T13:45:00Z  

## Проблема

Множественные критические проблемы в скриптах запуска приложения `dev-start.bat`:

1. **PowerShell не распознавал dev-start.bat** - требовался `.\` префикс
2. **Дублирование фронтенда на портах 3000/3001** - npm интерактивно запрашивал альтернативный порт
3. **Блокировка терминала** - команда `pause` блокировала выполнение
4. **Внешние терминалы** - `start cmd /k` открывало окна вне IDE
5. **Отсутствие проверки процессов** - создавались дублирующие процессы

## Диагностика

```bash
# Проверка запущенных процессов
tasklist | findstr /i "go.exe node.exe"

# Проверка занятых портов
netstat -an | findstr ":3000 :3001 :8080"

# Проверка Docker контейнеров
docker-compose ps
```

**Найдено:**
- 1 процесс go.exe (PID 13696) 
- 5 процессов node.exe (PID 7376, 22660, 4324, 5088, 21116)
- Порты 3000 и 8080 заняты
- Docker контейнеры работают корректно

## Решение

### 1. Исправлен `dev-start.bat`

**Изменения:**
- ✅ Добавлена проверка Docker
- ✅ Добавлена проверка и освобождение портов 3000, 3001, 8080
- ✅ Улучшена логика остановки процессов (специфично для npm start)
- ✅ Добавлены переменные `CI=true` и `BROWSER=none` для отключения интерактивных запросов
- ✅ Заменен `start /min cmd /c` на `start /b` для фонового выполнения
- ✅ Создание правильных .env файлов для backend и frontend
- ✅ Увеличены таймауты для стабильного запуска

**Улучшения архитектуры:**
```batch
[1/7] Checking prerequisites (Go, Node.js, Docker)
[2/7] Checking and freeing ports (3000, 3001, 8080)
[3/7] Stopping any existing processes (умная остановка npm start)
[4/7] Starting PostgreSQL (Docker)
[5/7] Waiting for database to be ready
[6/7] Installing frontend dependencies (с CI=true)
[7/7] Starting services (фоновые процессы)
```

### 2. Улучшен `dev-stop.bat`

**Новые возможности:**
- ✅ Умная остановка процессов по командной строке
- ✅ Освобождение портов по PID
- ✅ Корректная остановка Docker контейнеров
- ✅ Детальная отчетность о действиях

### 3. Переменные окружения

**Frontend (.env.local):**
```env
BROWSER=none
CI=true
SKIP_PREFLIGHT_CHECK=true
PORT=3000
```

**Backend (.env):**
```env
PORT=8080
DB_HOST=localhost
DB_PORT=5433
DB_NAME=project_master
DB_USER=postgres
DB_PASSWORD=postgres
```

## Тестирование

```bash
# Тест запуска
.\dev-start.bat

# Проверка работы сервисов
curl http://localhost:8080/health    # Backend
curl http://localhost:3000           # Frontend

# Тест остановки
.\dev-stop.bat
```

**Результат:** ✅ Все сервисы запускаются и работают корректно

## Файлы изменены

- `dev-start.bat` - полная переработка архитектуры
- `dev-stop.bat` - улучшена логика остановки
- `frontend/.env.local` - автогенерация при запуске
- `backend/.env` - автогенерация при запуске

## Известные ограничения

- Частично остается проблема с кодировкой терминала в некоторых конфигурациях Windows
- Требует PowerShell 5.0+ или Command Prompt для полной функциональности

## Команды для разработчика

```bash
# Запуск всех сервисов
.\dev-start.bat

# Остановка всех сервисов  
.\dev-stop.bat

# Перезапуск только backend
.\dev-restart-backend.bat

# Перезапуск только frontend
.\dev-restart-frontend.bat

# Просмотр логов
.\dev-logs-all.bat
```

**Время выполнения:** 25 минут  
**Влияние:** Критическое улучшение Developer Experience 